<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATH MASTER | Online P2P</title>
    <!-- Dependencies from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: white;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .option-btn {
            height: 80px;
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .option-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scale-in {
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .slide-right {
            animation: slideRight 0.5s ease-out;
        }

        @keyframes slideRight {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- TRANSLATIONS ---
        const translations = {
            TH: {
                title: "MATH MASTER",
                subtitle: "ระบบเกมคณิตศาสตร์ออนไลน์ความเร็วสูง",
                aboutUs: "เกี่ยวกับพวกเรา",
                start: "เริ่มต้นเล่นเกม",
                language: "ภาษา: ไทย",
                changeLang: "English",
                nickname: "ชื่อเล่นของคุณ",
                hostBtn: "สร้างห้องใหม่ (HOST)",
                joinBtn: "เข้าร่วมห้อง (JOIN)",
                roomPlaceholder: "ใส่รหัสห้อง (Room ID)",
                waiting: "กำลังรอผู้เล่นคนอื่น...",
                startHost: "เริ่มเกมเลย!",
                copyId: "คัดลอกรหัส",
                players: "ผู้เล่นทั้งหมด",
                question: "โจทย์ข้อที่",
                answered: "ตอบแล้ว",
                scoreboard: "อันดับคะแนน",
                preparing: "กำลังเตรียมข้อต่อไป...",
                victory: "ชัยชนะตกเป็นของ!",
                champion: "แชมป์เปี้ยน!",
                backHome: "กลับหน้าหลัก",
                team: [
                    "นายกรณ์มัฏฐ์ อินดา",
                    "นายพนกิจ สุรินทร์ต๊ะ",
                    "นายวุฒิภัทร ทาหย่อง",
                    "นายศิระกฤษ ศิริวงศ์",
                    "นายจตุรงค์ จิติโภคประเสริฐ"
                ]
            },
            EN: {
                title: "MATH MASTER",
                subtitle: "High-speed Online Multiplayer Math Game",
                aboutUs: "About Us",
                start: "Start Playing",
                language: "Language: English",
                changeLang: "ไทย",
                nickname: "Your Nickname",
                hostBtn: "HOST GAME",
                joinBtn: "JOIN GAME",
                roomPlaceholder: "Enter Room ID",
                waiting: "Waiting for other players...",
                startHost: "Start Game!",
                copyId: "Copy ID",
                players: "Players",
                question: "Question",
                answered: "Answered",
                scoreboard: "SCOREBOARD",
                preparing: "Preparing next question...",
                victory: "Winner Is!",
                champion: "CHAMPION!",
                backHome: "Back to Home",
                team: [
                    "Mr. Konmat Inda",
                    "Mr. Ponkit Surinta",
                    "Mr. Wuttipat Tayong",
                    "Mr. Sirakrit Siriwong",
                    "Mr. Jaturong Jitipokprasert"
                ]
            }
        };

        // --- MATH LOGIC ---
        const generateOptions = (correct) => {
            const options = new Set();
            options.add(correct);
            while (options.size < 4) {
                const offset = (Math.floor(Math.random() * 10) + 1) * (Math.random() > 0.5 ? 1 : -1);
                const op = correct + offset;
                if (op >= 0) options.add(op);
            }
            return Array.from(options).sort(() => Math.random() - 0.5);
        };

        const generateQuestion = () => {
            const a1 = Math.floor(Math.random() * 15) + 1;
            const d = Math.floor(Math.random() * 8) + 2;
            const seq = [a1, a1 + d, a1 + d * 2, a1 + d * 3, a1 + d * 4];
            const missingIdx = Math.floor(Math.random() * 5);
            const answer = seq[missingIdx];
            const displaySeq = [...seq];
            displaySeq[missingIdx] = '___';
            return {
                question: `${displaySeq.join(', ')}`,
                options: generateOptions(answer),
                answer
            };
        };

        function App() {
            const [lang, setLang] = useState(localStorage.getItem('math_lang') || 'TH');
            const [view, setView] = useState('landing'); // landing, home, about, waiting, playing, leaderboard, gameover
            const [myPeer, setMyPeer] = useState(null);
            const [peerId, setPeerId] = useState('');
            const [connected, setConnected] = useState(false);
            const [isHost, setIsHost] = useState(false);

            const [username, setUsername] = useState(localStorage.getItem('math_name') || '');
            const [roomCode, setRoomCode] = useState('');
            const [players, setPlayers] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [timer, setTimer] = useState(30);
            const [hasAnswered, setHasAnswered] = useState(false);
            const [answersCount, setAnswersCount] = useState({ received: 0, total: 0 });
            const [leaderboard, setLeaderboard] = useState([]);
            const [winnerList, setWinnerList] = useState([]);

            const connectionsRef = useRef([]);
            const hostConnRef = useRef(null);
            const gameRef = useRef({
                questions: [],
                idx: 0,
                players: [],
                received: 0,
                timerId: null
            });

            const t = translations[lang];

            // Initialize Peer on demand or start
            useEffect(() => {
                const peer = new Peer();
                peer.on('open', (id) => {
                    setMyPeer(peer);
                    setPeerId(id);
                    setConnected(true);
                });
                peer.on('error', () => setConnected(false));

                const params = new URLSearchParams(window.location.search);
                const r = params.get('room');
                if (r) {
                    setRoomCode(r);
                    setView('home');
                }
                return () => peer.destroy();
            }, []);

            useEffect(() => {
                if (!myPeer || !isHost) return;
                myPeer.on('connection', (conn) => {
                    conn.on('open', () => {
                        conn.on('data', (data) => handleHostMessage(conn, data));
                        connectionsRef.current.push(conn);
                    });
                });
            }, [myPeer, isHost]);

            const handleHostMessage = (conn, data) => {
                const g = gameRef.current;
                if (data.type === 'join') {
                    if (g.players.length >= 10) return conn.send({ type: 'error', msg: 'Room full' });
                    const p = { id: conn.peer, name: data.name, score: 0 };
                    g.players.push(p);
                    setPlayers([...g.players]);
                    hostBroadcast({ type: 'player_list', players: g.players });
                }
                if (data.type === 'answer') {
                    const player = g.players.find(p => p.id === conn.peer);
                    if (player && !player.answered) {
                        player.answered = true;
                        if (data.answer === g.questions[g.idx].answer) player.score += 1;
                        g.received++;
                        hostBroadcast({ type: 'answer_update', received: g.received, total: g.players.length });
                        if (g.received === g.players.length) {
                            clearTimeout(g.timerId);
                            showLeaderboard();
                        }
                    }
                }
            };

            const hostBroadcast = (data) => {
                connectionsRef.current.forEach(c => c.send(data));
                processHostUpdate(data);
            };

            const processHostUpdate = (data) => {
                if (data.type === 'player_list') setPlayers(data.players);
                if (data.type === 'next_q') {
                    setCurrentQuestion(data);
                    setView('playing');
                    setHasAnswered(false);
                    setTimer(30);
                    setAnswersCount({ received: 0, total: gameRef.current.players.length });
                }
                if (data.type === 'answer_update') setAnswersCount({ received: data.received, total: data.total });
                if (data.type === 'leaderboard') {
                    setLeaderboard([...data.players]);
                    setView('leaderboard');
                }
                if (data.type === 'game_over') {
                    setWinnerList(data.ranking);
                    setView('gameover');
                    confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
                }
            };

            const createRoom = () => {
                setIsHost(true);
                const initialPlayers = [{ id: 'me', name: username, score: 0 }];
                gameRef.current.players = initialPlayers;
                setPlayers(initialPlayers);
                setView('waiting');
            };

            const hostStartGame = () => {
                if (players.length < 2) return alert(lang === 'TH' ? 'ต้องการอย่างน้อย 2 คน' : 'Need at least 2 players');
                const g = gameRef.current;
                g.questions = Array.from({ length: 10 }, () => generateQuestion());
                g.idx = 0;
                sendNextQuestion();
            };

            const sendNextQuestion = () => {
                const g = gameRef.current;
                if (g.idx < 10) {
                    g.received = 0;
                    g.players.forEach(p => p.answered = false);
                    const qData = g.questions[g.idx];
                    hostBroadcast({
                        type: 'next_q',
                        question: qData.question,
                        options: qData.options,
                        num: g.idx + 1,
                        total: 10
                    });
                    g.timerId = setTimeout(showLeaderboard, 30000);
                } else {
                    const sorted = [...g.players].sort((a, b) => b.score - a.score);
                    hostBroadcast({ type: 'game_over', ranking: sorted.slice(0, 5) });
                }
            };

            const showLeaderboard = () => {
                const g = gameRef.current;
                const sorted = [...g.players].sort((a, b) => b.score - a.score);
                hostBroadcast({ type: 'leaderboard', players: sorted });
                g.idx++;
                setTimeout(sendNextQuestion, 5000);
            };

            const joinRoom = () => {
                if (!roomCode) return alert('Enter Room ID');
                const conn = myPeer.connect(roomCode);
                hostConnRef.current = conn;
                conn.on('open', () => {
                    conn.send({ type: 'join', name: username });
                    setView('waiting');
                });
                conn.on('data', (data) => processHostUpdate(data));
                conn.on('close', () => alert('Host disconnected'));
            };

            const submitAnswer = (val) => {
                setHasAnswered(true);
                if (isHost) {
                    const g = gameRef.current;
                    const p = g.players.find(p => p.id === 'me');
                    p.answered = true;
                    if (val === g.questions[g.idx].answer) p.score += 1;
                    g.received++;
                    hostBroadcast({ type: 'answer_update', received: g.received, total: g.players.length });
                    if (g.received === g.players.length) {
                        clearTimeout(g.timerId);
                        showLeaderboard();
                    }
                } else {
                    hostConnRef.current.send({ type: 'answer', answer: val });
                }
            };

            const toggleLang = () => {
                const newLang = lang === 'TH' ? 'EN' : 'TH';
                setLang(newLang);
                localStorage.setItem('math_lang', newLang);
            };

            useEffect(() => {
                let itv;
                if (view === 'playing' && timer > 0) itv = setInterval(() => setTimer(t => t - 1), 1000);
                return () => clearInterval(itv);
            }, [view, timer]);

            useEffect(() => { localStorage.setItem('math_name', username); }, [username]);

            // --- UI SCREENS ---

            if (view === 'landing') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 fade-in text-center">
                    <div className="mb-12 scale-in">
                        <h1 className="text-7xl font-black italic mb-4 bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent">MATH MASTER</h1>
                        <p className="text-xl opacity-60 font-light tracking-wide">{t.subtitle}</p>
                    </div>

                    <div className="flex flex-col gap-4 w-full max-w-sm scale-in">
                        <button onClick={() => setView('home')} className="btn-primary p-6 rounded-2xl font-bold text-2xl shadow-xl shadow-indigo-500/20">{t.start}</button>
                        <button onClick={() => setView('about')} className="bg-white/5 border border-white/10 p-4 rounded-xl font-bold hover:bg-white/10 transition-all">{t.aboutUs}</button>
                        <button onClick={toggleLang} className="opacity-40 text-sm hover:opacity-100 transition-all">{t.language} ({t.changeLang})</button>
                    </div>

                    <div className="mt-20 opacity-20 text-[10px] uppercase tracking-widest font-bold">
                        Powered by PeerJS Serverless Technology
                    </div>
                </div>
            );

            if (view === 'about') return (
                <div className="min-h-screen flex items-center justify-center p-6 slide-right">
                    <div className="max-w-md w-full glass-card p-10 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10 font-black text-6xl">TEAM</div>
                        <h2 className="text-4xl font-black mb-8 border-b border-white/10 pb-4">{t.aboutUs}</h2>
                        <ul className="space-y-4">
                            {t.team.map((name, i) => (
                                <li key={i} className="flex items-center gap-4 group">
                                    <div className="w-8 h-8 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold group-hover:bg-indigo-500 group-hover:text-white transition-all">{i + 1}</div>
                                    <span className="text-lg font-medium opacity-80">{name}</span>
                                </li>
                            ))}
                        </ul>
                        <button onClick={() => setView('landing')} className="mt-10 w-full p-4 rounded-xl border border-white/10 font-bold hover:bg-white/5 transition-all">{t.backHome}</button>
                    </div>
                </div>
            );

            if (view === 'home') return (
                <div className="max-w-md mx-auto pt-32 p-8 fade-in">
                    <div className="fixed top-4 right-4 flex items-center gap-2 px-3 py-1 glass-card border-none text-[10px] font-bold">
                        <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                        {connected ? 'SERVERLESS ONLINE' : 'INITIALIZING...'}
                    </div>
                    <div className="glass-card p-10 text-center shadow-2xl relative">
                        <button onClick={() => setView('landing')} className="absolute top-4 left-4 opacity-40 hover:opacity-100 text-xs">← {t.backHome}</button>
                        <h1 className="text-4xl font-black mb-10 italic text-cyan-400">MATH MASTER</h1>
                        <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none focus:border-cyan-500 font-bold" placeholder={t.nickname} value={username} onChange={e => setUsername(e.target.value)} />
                        <button onClick={createRoom} disabled={!connected || !username} className="w-full btn-primary p-4 rounded-xl font-bold text-lg mb-6 active:scale-95 disabled:opacity-30">{t.hostBtn}</button>
                        <div className="border-t border-white/10 pt-6 text-center">
                            <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none focus:border-cyan-500" placeholder={t.roomPlaceholder} value={roomCode} onChange={e => setRoomCode(e.target.value)} />
                            <button onClick={joinRoom} disabled={!connected || !username || !roomCode} className="w-full border border-white/20 p-4 rounded-xl font-bold hover:bg-white/5 disabled:opacity-30">{t.joinBtn}</button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'waiting') return (
                <div className="max-w-xl mx-auto mt-20 p-8 fade-in text-center">
                    <div className="glass-card p-10 mb-6 bg-gradient-to-br from-indigo-500/10 to-transparent border-t-4 border-indigo-500 shadow-2xl">
                        <p className="text-xs font-bold tracking-widest text-indigo-400 uppercase mb-2">Room ID</p>
                        <h2 className="text-3xl font-mono bg-white/10 p-4 rounded-xl overflow-hidden break-all select-all font-bold tracking-tighter">{peerId || roomCode}</h2>
                        <button onClick={() => { navigator.clipboard.writeText(peerId || roomCode); alert('ID Copied!') }} className="text-[10px] mt-4 opacity-50 underline">{t.copyId}</button>
                    </div>
                    <div className="glass-card p-8 text-left">
                        <div className="flex justify-between items-center mb-8 border-b border-white/5 pb-4">
                            <h3 className="text-2xl font-black tracking-tighter italic uppercase">{t.players} ({players.length}/10)</h3>
                            {isHost && <button onClick={hostStartGame} className="btn-primary px-10 py-3 rounded-2xl font-black uppercase text-sm tracking-widest animate-pulse border-2 border-white/10">{t.startHost}</button>}
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            {players.map((p, i) => (
                                <div key={i} className="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center gap-3 slide-up">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs ${i % 2 === 0 ? 'bg-cyan-500' : 'bg-purple-500'}`}>{p.name[0]}</div>
                                    <span className="font-bold text-sm tracking-tight">{p.name} {p.id === 'me' && '(You)'}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (view === 'playing') return (
                <div className="max-w-4xl mx-auto mt-12 p-6 fade-in">
                    <div className="flex justify-between items-center mb-8">
                        <div className="glass-card px-6 py-3 flex items-center gap-6 border-none shadow-xl scale-in">
                            <span className="text-indigo-400 font-extrabold text-xl tracking-tighter flex items-center gap-2">
                                <span className="text-[10px] uppercase opacity-40">Q</span>{currentQuestion.num}/10
                            </span>
                            <span className={`text-2xl font-black ${timer < 5 ? 'text-rose-500 animate-bounce' : 'text-yellow-400'}`}>⏱ {timer}s</span>
                            <div className="flex items-center gap-1 bg-white/10 rounded-full px-3 py-1">
                                <span className="text-emerald-400 font-black text-xs">✓ {answersCount.received}/{answersCount.total}</span>
                                <span className="text-[10px] opacity-40 font-bold uppercase">{t.answered}</span>
                            </div>
                        </div>
                        <div className="font-black text-indigo-400 border-r-4 border-indigo-500 pr-4">{username}</div>
                    </div>
                    <div className="glass-card p-16 text-center mb-10 border-b-[16px] border-indigo-600 min-h-[250px] flex items-center justify-center shadow-inner relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-20 animate-pulse"></div>
                        <h2 className="text-6xl font-black whitespace-pre-wrap leading-none tracking-tighter">{currentQuestion.question}</h2>
                    </div>
                    <div className="grid grid-cols-2 gap-6">
                        {currentQuestion.options.map((opt, i) => (
                            <button key={i} onClick={() => submitAnswer(opt)} disabled={hasAnswered} className={`option-btn shadow-2xl text-3xl font-black border-b-4 border-black/20 ${['bg-rose-500', 'bg-sky-500', 'bg-amber-500', 'bg-emerald-500'][i]} ${hasAnswered ? 'opacity-20 grayscale cursor-not-allowed' : 'hover:scale-[1.02] active:scale-95 transition-all'}`}>{opt}</button>
                        ))}
                    </div>
                    {hasAnswered && <div className="text-center mt-12 text-cyan-400 font-black text-xl tracking-widest animate-pulse italic lowercase">{t.waiting}</div>}
                </div>
            );

            if (view === 'leaderboard') return (
                <div className="max-w-xl mx-auto mt-16 p-8 fade-in">
                    <h2 className="text-5xl font-black text-center mb-10 italic tracking-tighter bg-gradient-to-b from-white to-white/20 bg-clip-text text-transparent">{t.scoreboard}</h2>
                    <div className="space-y-4">
                        {leaderboard.map((p, i) => (
                            <div key={i} className={`p-6 glass-card flex justify-between items-center slide-up ${i === 0 ? 'bg-indigo-500/20 border-indigo-500 shadow-indigo-500/20 shadow-2xl scale-105' : ''}`} style={{ animationDelay: `${i * 0.1}s` }}>
                                <div className="flex items-center gap-6 font-bold">
                                    <span className="text-4xl font-black opacity-10">#{i + 1}</span>
                                    <span className="text-2xl tracking-tighter uppercase italic">{p.name}</span>
                                </div>
                                <div className="text-4xl font-black text-indigo-400 drop-shadow-lg">{p.score} <span className="text-xs uppercase opacity-30 font-bold">pts</span></div>
                            </div>
                        ))}
                    </div>
                    <div className="text-center mt-12 opacity-50 italic animate-pulse font-bold tracking-widest text-xs uppercase">{t.preparing}</div>
                </div>
            );

            if (view === 'gameover') return (
                <div className="max-w-2xl mx-auto mt-20 p-10 fade-in text-center">
                    <h1 className="text-7xl font-black italic mb-12 tracking-tighter text-indigo-500 uppercase">{t.champion}</h1>
                    <div className="space-y-4 mb-16 max-w-md mx-auto">
                        {winnerList.map((p, i) => (
                            <div key={i} className={`flex items-center justify-between p-6 glass-card border-none slide-up ${i === 0 ? 'scale-110 bg-gradient-to-r from-yellow-500/30 to-transparent border-l-8 border-yellow-500 shadow-gold' : ''}`} style={{ animationDelay: `${i * 0.1}s` }}>
                                <div className="flex items-center gap-6">
                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center font-black text-2xl ${i === 0 ? 'bg-yellow-500 text-black' : i === 1 ? 'bg-slate-300 text-black' : i === 2 ? 'bg-amber-600 text-black' : 'bg-white/10'}`}>
                                        {i === 0 ? '1st' : i === 1 ? '2nd' : i === 2 ? '3rd' : `${i + 1}th`}
                                    </div>
                                    <span className="text-2xl font-black tracking-tighter italic uppercase">{p.name}</span>
                                </div>
                                <span className="text-3xl font-black opacity-40">{p.score} <span className="text-xs">pts</span></span>
                            </div>
                        ))}
                    </div>
                    <button onClick={() => window.location.reload()} className="btn-primary px-12 py-5 rounded-3xl font-black text-2xl shadow-2xl shadow-indigo-500/40 hover:rotate-1 tracking-tighter uppercase">{t.backHome}</button>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>