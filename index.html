<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATH MASTER | Standalone Edition</title>
    <!-- Dependencies from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: white;
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .option-btn {
            height: 80px;
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .option-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [socket, setSocket] = useState(null);
            const [connected, setConnected] = useState(false);
            const [username, setUsername] = useState(localStorage.getItem('math_username') || '');
            const [serverUrl, setServerUrl] = useState(localStorage.getItem('math_server_url') || '');
            const [roomCode, setRoomCode] = useState('');
            const [gameState, setGameState] = useState('home');
            const [players, setPlayers] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [leaderboardData, setLeaderboardData] = useState(null);
            const [gameOverData, setGameOverData] = useState(null);
            const [isHost, setIsHost] = useState(false);
            const [hasAnswered, setHasAnswered] = useState(false);
            const [timer, setTimer] = useState(30);
            const [answersCount, setAnswersCount] = useState({ received: 0, total: 0 });

            useEffect(() => {
                const isLocalFile = window.location.protocol === 'file:';
                const detectedUrl = isLocalFile || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:5000'
                    : serverUrl || window.location.origin;

                if (!serverUrl) setServerUrl(detectedUrl);
                connectToSocket(serverUrl || detectedUrl);
            }, []);

            const connectToSocket = (url) => {
                if (socket) socket.disconnect();
                console.log('Connecting to:', url);
                const s = io(url, { reconnectionAttempts: 3, timeout: 5000 });
                setSocket(s);

                s.on('connect', () => {
                    setConnected(true);
                    localStorage.setItem('math_server_url', url);
                });
                s.on('disconnect', () => setConnected(false));
                s.on('connect_error', () => setConnected(false));

                s.on('room_created', ({ roomCode, players }) => {
                    setRoomCode(roomCode);
                    setPlayers(players);
                    setGameState('waiting');
                    setIsHost(true);
                });

                s.on('player_joined', ({ players }) => setPlayers(players));

                s.on('joined_successfully', ({ roomCode, players }) => {
                    setRoomCode(roomCode);
                    setPlayers(players);
                    setGameState('waiting');
                    setIsHost(false);
                });

                s.on('next_question', (question) => {
                    setCurrentQuestion(question);
                    setGameState('playing');
                    setHasAnswered(false);
                    setTimer(30);
                    setAnswersCount({ received: 0, total: players.length });
                });

                s.on('answer_update', (data) => setAnswersCount(data));

                s.on('leaderboard', (data) => {
                    setLeaderboardData(data);
                    setGameState('leaderboard');
                });

                s.on('game_over', (data) => {
                    setGameOverData(data);
                    setGameState('gameover');
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                });

                s.on('error', (msg) => alert('‚ö†Ô∏è ' + msg));
            };

            useEffect(() => {
                localStorage.setItem('math_username', username);
            }, [username]);

            useEffect(() => {
                let interval;
                if (gameState === 'playing' && timer > 0) {
                    interval = setInterval(() => setTimer(prev => prev - 1), 1000);
                }
                return () => clearInterval(interval);
            }, [gameState, timer]);

            const createRoom = () => username && socket.emit('create_room', { username });
            const joinRoom = () => username && roomCode && socket.emit('join_room', { roomCode, username });
            const startGame = () => socket.emit('start_game', { roomCode });
            const submitAnswer = (option) => {
                if (hasAnswered) return;
                setHasAnswered(true);
                socket.emit('submit_answer', { roomCode, answer: option });
            };

            const copyJoinLink = () => {
                const url = window.location.origin + window.location.pathname + '?room=' + roomCode;
                navigator.clipboard.writeText(url);
                alert('Join link copied to clipboard!\nSend it to your friends.');
            };

            // Auto-fill room code from URL if present
            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const r = params.get('room');
                if (r) setRoomCode(r.toUpperCase());
            }, []);

            if (gameState === 'home') return (
                <div className="relative min-h-screen">
                    <div className="fixed top-4 right-4 flex flex-col items-end gap-2">
                        <div className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-2 ${connected ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                            <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                            {connected ? 'ONLINE' : 'OFFLINE'}
                        </div>
                        <div className="flex flex-col gap-1 items-end">
                            <label className="text-[10px] opacity-40 uppercase font-bold">Backend Server URL</label>
                            <div className="flex gap-2">
                                <input
                                    className="bg-white/10 border border-white/20 text-[10px] p-2 rounded outline-none w-48"
                                    placeholder="https://your-server.onrender.com"
                                    value={serverUrl}
                                    onChange={e => setServerUrl(e.target.value)}
                                />
                                <button onClick={() => connectToSocket(serverUrl)} className="bg-indigo-500 text-[10px] px-3 py-1 rounded font-bold hover:bg-indigo-400">Connect</button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-md mx-auto pt-32 p-10 glass-card text-center shadow-2xl">
                        <h1 className="text-5xl font-black mb-10 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">MATH MASTER</h1>
                        <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none focus:border-indigo-500" placeholder="Nickname" value={username} onChange={e => setUsername(e.target.value)} />
                        <button
                            onClick={createRoom}
                            disabled={!connected}
                            className={`w-full p-4 rounded-xl font-bold text-lg mb-6 ${connected ? 'btn-primary' : 'bg-white/10 opacity-50 cursor-not-allowed'}`}
                        >
                            Create Room
                        </button>
                        <div className="border-t border-white/10 pt-6">
                            <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none" placeholder="Room Code" value={roomCode} onChange={e => setRoomCode(e.target.value.toUpperCase())} />
                            <button
                                onClick={joinRoom}
                                disabled={!connected}
                                className={`w-full border p-4 rounded-xl font-bold ${connected ? 'border-white/20 hover:bg-white/5' : 'border-white/5 opacity-50 cursor-not-allowed'}`}
                            >
                                Join Room
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (gameState === 'waiting') return (
                <div className="max-w-2xl mx-auto mt-16 p-8">
                    <div className="glass-card p-10 text-center mb-8">
                        <p className="text-indigo-400 font-bold tracking-widest uppercase">Room Code</p>
                        <h1 className="text-7xl font-black">{roomCode}</h1>
                    </div>
                    <div className="glass-card p-8">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold">Players ({players.length})</h2>
                                <button onClick={copyJoinLink} className="text-indigo-400 text-sm font-bold mt-1 hover:underline">üîó Copy Invite Link</button>
                            </div>
                            {isHost && <button onClick={startGame} className="btn-primary px-8 py-3 rounded-xl font-bold animate-pulse">Start Game</button>}
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            {players.map(p => (
                                <div key={p.id} className="p-4 bg-white/5 rounded-xl border border-white/5 flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold">{p.username[0]}</div>
                                    <span>{p.username}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (gameState === 'playing') return (
                <div className="max-w-4xl mx-auto mt-16 p-6">
                    <div className="flex justify-between items-center mb-8">
                        <div className="glass-card px-6 py-2 flex items-center gap-4">
                            <span className="text-indigo-400 font-bold">Q{currentQuestion.number}/10</span>
                            <span className="text-yellow-400 font-bold">‚è± {timer}s</span>
                            <span className="text-green-400 font-bold ml-4">‚úì {answersCount.received}/{answersCount.total} Answered</span>
                        </div>
                        <div className="text-xl font-bold opacity-60">{username}</div>
                    </div>
                    <div className="glass-card p-16 text-center mb-10 min-h-[250px] flex items-center justify-center border-b-4 border-indigo-500">
                        <h1 className="text-5xl font-extrabold">{currentQuestion.question}</h1>
                    </div>
                    <div className="quiz-grid">
                        {currentQuestion.options.map((opt, i) => (
                            <button key={i} onClick={() => submitAnswer(opt)}
                                className={`option-btn ${['bg-red-500', 'bg-blue-500', 'bg-yellow-500', 'bg-green-500'][i]} ${hasAnswered ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105'}`}>
                                {opt}
                            </button>
                        ))}
                    </div>
                </div>
            );

            if (gameState === 'leaderboard') return (
                <div className="max-w-2xl mx-auto mt-16 p-8">
                    <h1 className="text-5xl font-black text-center mb-10 italic">TOP PLAYERS</h1>
                    <div className="space-y-4">
                        {leaderboardData.players.map((p, i) => (
                            <div key={p.id} className={`p-6 glass-card flex justify-between items-center ${i === 0 ? 'border-yellow-500 border-2 bg-yellow-500/10' : ''}`}>
                                <div className="flex items-center gap-4">
                                    <span className="text-3xl font-black opacity-20">#{i + 1}</span>
                                    <span className="text-2xl font-bold">{p.username}</span>
                                </div>
                                <div className="text-3xl font-black text-indigo-400">{p.score}</div>
                            </div>
                        ))}
                    </div>
                    <p className="text-center mt-10 text-white/40 animate-bounce">Next question coming soon...</p>
                </div>
            );

            if (gameState === 'gameover') return (
                <div className="max-w-md mx-auto mt-32 p-10 glass-card text-center">
                    <span className="text-8xl">üèÜ</span>
                    <h1 className="text-6xl font-black mb-4">FINISH!</h1>
                    <h2 className="text-3xl font-bold text-yellow-400 mb-2">{gameOverData.winner.username}</h2>
                    <p className="text-5xl font-black mb-10">{gameOverData.winner.score} pts</p>
                    <button onClick={() => window.location.reload()} className="w-full btn-primary p-4 rounded-xl font-bold">Back to Menu</button>
                </div>
            );

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>