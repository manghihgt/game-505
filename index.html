<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MATH MASTER | Online P2P</title>
    <!-- Dependencies from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top left, #1e1b4b, #0f172a);
            color: white;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .option-btn {
            height: 80px;
            font-size: 1.25rem;
            font-weight: 700;
            border-radius: 12px;
            transition: transform 0.2s;
        }

        .option-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- MATH LOGIC ---
        const generateOptions = (correct) => {
            const options = new Set();
            options.add(correct);
            while (options.size < 4) {
                const offset = (Math.floor(Math.random() * 10) + 1) * (Math.random() > 0.5 ? 1 : -1);
                const op = correct + offset;
                if (op >= 0) options.add(op);
            }
            return Array.from(options).sort(() => Math.random() - 0.5);
        };

        const generateQuestion = () => {
            const a1 = Math.floor(Math.random() * 15) + 1;
            const d = Math.floor(Math.random() * 8) + 2;
            const seq = [a1, a1 + d, a1 + d * 2, a1 + d * 3, a1 + d * 4];
            const missingIdx = Math.floor(Math.random() * 5);
            const answer = seq[missingIdx];
            const displaySeq = [...seq];
            displaySeq[missingIdx] = '___';
            return {
                question: `Find the missing number:\n${displaySeq.join(', ')}`,
                options: generateOptions(answer),
                answer
            };
        };

        function App() {
            const [myPeer, setMyPeer] = useState(null);
            const [peerId, setPeerId] = useState('');
            const [connected, setConnected] = useState(false);
            const [isHost, setIsHost] = useState(false);

            const [username, setUsername] = useState(localStorage.getItem('math_name') || '');
            const [roomCode, setRoomCode] = useState('');
            const [gameState, setGameState] = useState('home');
            const [players, setPlayers] = useState([]);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [timer, setTimer] = useState(30);
            const [hasAnswered, setHasAnswered] = useState(false);
            const [answersCount, setAnswersCount] = useState({ received: 0, total: 0 });
            const [leaderboard, setLeaderboard] = useState([]);
            const [winner, setWinner] = useState(null);

            const connectionsRef = useRef([]); // For Host
            const hostConnRef = useRef(null); // For Client
            const gameRef = useRef({
                questions: [],
                idx: 0,
                players: [],
                received: 0,
                timerId: null
            });

            // Initialize Peer on start
            useEffect(() => {
                const peer = new Peer();
                peer.on('open', (id) => {
                    setMyPeer(peer);
                    setPeerId(id);
                    setConnected(true);
                    console.log('Peer ID:', id);
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    setConnected(false);
                });

                // URL Room Code Support
                const params = new URLSearchParams(window.location.search);
                const r = params.get('room');
                if (r) setRoomCode(r);

                return () => peer.destroy();
            }, []);

            // --- HOST LOGIC ---
            useEffect(() => {
                if (!myPeer || !isHost) return;

                myPeer.on('connection', (conn) => {
                    conn.on('open', () => {
                        conn.on('data', (data) => handleHostMessage(conn, data));
                        connectionsRef.current.push(conn);
                    });
                });
            }, [myPeer, isHost]);

            const handleHostMessage = (conn, data) => {
                const g = gameRef.current;
                if (data.type === 'join') {
                    if (g.players.length >= 10) return conn.send({ type: 'error', msg: 'Room full' });
                    const p = { id: conn.peer, name: data.name, score: 0 };
                    g.players.push(p);
                    setPlayers([...g.players]);
                    hostBroadcast({ type: 'player_list', players: g.players });
                }

                if (data.type === 'answer') {
                    const player = g.players.find(p => p.id === conn.peer);
                    if (player && !player.answered) {
                        player.answered = true;
                        if (data.answer === g.questions[g.idx].answer) player.score += 1;
                        g.received++;
                        hostBroadcast({ type: 'answer_update', received: g.received, total: g.players.length });
                        if (g.received === g.players.length) {
                            clearTimeout(g.timerId);
                            showLeaderboard();
                        }
                    }
                }
            };

            const hostBroadcast = (data) => {
                connectionsRef.current.forEach(c => c.send(data));
                processHostUpdate(data);
            };

            const processHostUpdate = (data) => {
                if (data.type === 'player_list') setPlayers(data.players);
                if (data.type === 'next_q') {
                    setCurrentQuestion(data);
                    setGameState('playing');
                    setHasAnswered(false);
                    setTimer(30);
                    setAnswersCount({ received: 0, total: gameRef.current.players.length });
                }
                if (data.type === 'answer_update') setAnswersCount({ received: data.received, total: data.total });
                if (data.type === 'leaderboard') {
                    setLeaderboard([...data.players]);
                    setGameState('leaderboard');
                }
                if (data.type === 'game_over') {
                    setWinner(data.winner);
                    setGameState('gameover');
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }
            };

            const createRoom = () => {
                setIsHost(true);
                const initialPlayers = [{ id: 'me', name: username, score: 0 }];
                gameRef.current.players = initialPlayers;
                setPlayers(initialPlayers);
                setGameState('waiting');
            };

            const hostStartGame = () => {
                if (players.length < 2) return alert('At least 2 players needed!');
                const g = gameRef.current;
                g.questions = Array.from({ length: 10 }, () => generateQuestion());
                g.idx = 0;
                sendNextQuestion();
            };

            const sendNextQuestion = () => {
                const g = gameRef.current;
                if (g.idx < 10) {
                    g.received = 0;
                    g.players.forEach(p => p.answered = false);
                    const qData = g.questions[g.idx];
                    hostBroadcast({
                        type: 'next_q',
                        question: qData.question,
                        options: qData.options,
                        num: g.idx + 1,
                        total: 10
                    });
                    g.timerId = setTimeout(showLeaderboard, 30000);
                } else {
                    const sorted = [...g.players].sort((a, b) => b.score - a.score);
                    hostBroadcast({ type: 'game_over', winner: sorted[0] });
                }
            };

            const showLeaderboard = () => {
                const g = gameRef.current;
                const sorted = [...g.players].sort((a, b) => b.score - a.score);
                hostBroadcast({ type: 'leaderboard', players: sorted });
                g.idx++;
                setTimeout(sendNextQuestion, 5000);
            };

            // --- CLIENT LOGIC ---
            const joinRoom = () => {
                if (!roomCode) return alert('Enter Room ID');
                const conn = myPeer.connect(roomCode);
                hostConnRef.current = conn;
                conn.on('open', () => {
                    conn.send({ type: 'join', name: username });
                    setGameState('waiting');
                });
                conn.on('data', (data) => processHostUpdate(data));
                conn.on('close', () => alert('Host disconnected'));
            };

            const submitAnswer = (val) => {
                setHasAnswered(true);
                if (isHost) {
                    const g = gameRef.current;
                    const p = g.players.find(p => p.id === 'me');
                    p.answered = true;
                    if (val === g.questions[g.idx].answer) p.score += 1;
                    g.received++;
                    hostBroadcast({ type: 'answer_update', received: g.received, total: g.players.length });
                    if (g.received === g.players.length) {
                        clearTimeout(g.timerId);
                        showLeaderboard();
                    }
                } else {
                    hostConnRef.current.send({ type: 'answer', answer: val });
                }
            };

            // Global Timer Effect
            useEffect(() => {
                let itv;
                if (gameState === 'playing' && timer > 0) {
                    itv = setInterval(() => setTimer(t => t - 1), 1000);
                }
                return () => clearInterval(itv);
            }, [gameState, timer]);

            useEffect(() => { localStorage.setItem('math_name', username); }, [username]);

            if (gameState === 'home') return (
                <div className="max-w-md mx-auto pt-32 p-8 fade-in">
                    <div className="fixed top-4 right-4 flex items-center gap-2 px-3 py-1 glass-card border-none text-[10px] font-bold">
                        <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                        {connected ? 'SERVERLESS ONLINE' : 'INITIALIZING...'}
                    </div>
                    <div className="glass-card p-10 text-center shadow-2xl">
                        <h1 className="text-5xl font-black mb-10 bg-gradient-to-r from-cyan-400 to-blue-500 bg-clip-text text-transparent italic">MATH MASTER</h1>
                        <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none focus:border-cyan-500 font-bold" placeholder="Your Nickname" value={username} onChange={e => setUsername(e.target.value)} />
                        <button onClick={createRoom} disabled={!connected || !username} className="w-full btn-primary p-4 rounded-xl font-bold text-lg mb-6 active:scale-95 disabled:opacity-30">HOST GAME</button>
                        <div className="border-t border-white/10 pt-6">
                            <input className="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-4 outline-none focus:border-cyan-500" placeholder="Room ID (From Host)" value={roomCode} onChange={e => setRoomCode(e.target.value)} />
                            <button onClick={joinRoom} disabled={!connected || !username || !roomCode} className="w-full border border-white/20 p-4 rounded-xl font-bold hover:bg-white/5 disabled:opacity-30">JOIN GAME</button>
                        </div>
                    </div>
                </div>
            );

            if (gameState === 'waiting') return (
                <div className="max-w-xl mx-auto mt-20 p-8 fade-in text-center">
                    <div className="glass-card p-8 mb-6">
                        <p className="text-xs font-bold tracking-widest text-cyan-400 uppercase mb-2">Room ID</p>
                        <h2 className="text-xl font-mono bg-white/10 p-3 rounded-lg overflow-hidden break-all select-all">{peerId || roomCode}</h2>
                        <button onClick={() => { navigator.clipboard.writeText(peerId || roomCode); alert('ID Copied!') }} className="text-[10px] mt-2 opacity-50 underline">Copy ID</button>
                    </div>
                    <div className="glass-card p-8">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-left">Players ({players.length}/10)</h3>
                            {isHost && <button onClick={hostStartGame} className="btn-primary px-8 py-2 rounded-xl font-bold animate-pulse">Start</button>}
                        </div>
                        <div className="grid grid-cols-2 gap-3 text-left">
                            {players.map((p, i) => (
                                <div key={i} className="p-3 bg-white/5 rounded-lg border border-white/5 flex items-center gap-2">
                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs ${i % 2 === 0 ? 'bg-cyan-500' : 'bg-purple-500'}`}>{p.name[0]}</div>
                                    <span className="text-sm font-medium truncate">{p.name} {p.id === 'me' && '(You)'}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (gameState === 'playing') return (
                <div className="max-w-4xl mx-auto mt-12 p-6 fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <div className="glass-card px-5 py-2 flex items-center gap-4 border-none text-sm">
                            <span className="text-cyan-400 font-bold">Q{currentQuestion.num}/10</span>
                            <span className={`font-bold ${timer < 5 ? 'text-rose-500 animate-bounce' : 'text-yellow-400'}`}>‚è± {timer}s</span>
                            <span className="text-emerald-400 font-bold ml-2">‚úì {answersCount.received}/{answersCount.total}</span>
                        </div>
                        <div className="font-bold opacity-40 text-xs tracking-widest uppercase">{username}</div>
                    </div>
                    <div className="glass-card p-12 text-center mb-8 border-b-[10px] border-cyan-500 min-h-[220px] flex items-center justify-center">
                        <h2 className="text-5xl font-black whitespace-pre-wrap leading-tight tracking-tight">{currentQuestion.question}</h2>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        {currentQuestion.options.map((opt, i) => (
                            <button key={i} onClick={() => submitAnswer(opt)} disabled={hasAnswered} className={`option-btn shadow-xl ${['bg-rose-500', 'bg-sky-500', 'bg-amber-500', 'bg-emerald-500'][i]} ${hasAnswered ? 'opacity-20 grayscale cursor-not-allowed' : 'hover:scale-[1.02] active:scale-95'}`}>{opt}</button>
                        ))}
                    </div>
                    {hasAnswered && <div className="text-center mt-8 text-cyan-400 font-bold animate-pulse">Waiting for teammates...</div>}
                </div>
            );

            if (gameState === 'leaderboard') return (
                <div className="max-w-xl mx-auto mt-16 p-8 fade-in">
                    <h2 className="text-4xl font-black text-center mb-8 italic text-cyan-400">LEADERBOARD</h2>
                    <div className="space-y-3">
                        {leaderboard.map((p, i) => (
                            <div key={i} className={`p-5 glass-card flex justify-between items-center ${i === 0 ? 'bg-cyan-500/20 border-cyan-500 shadow-cyan-500/20 shadow-lg scale-105' : ''}`}>
                                <div className="flex items-center gap-4 font-bold">
                                    <span className="text-2xl opacity-20">#{i + 1}</span>
                                    <span className="text-xl">{p.name}</span>
                                </div>
                                <div className="text-3xl font-black text-cyan-400">{p.score} <span className="text-xs uppercase opacity-30">pts</span></div>
                            </div>
                        ))}
                    </div>
                    <div className="text-center mt-10 opacity-50 italic animate-pulse">Next round starting soon...</div>
                </div>
            );

            if (gameState === 'gameover') return (
                <div className="max-w-md mx-auto mt-32 p-10 glass-card text-center scale-in shadow-2xl border-t-[12px] border-yellow-500">
                    <div className="text-9xl mb-6">üèÜ</div>
                    <h2 className="text-6xl font-black mb-2 italic">CHAMPION!</h2>
                    <h3 className="text-3xl font-bold text-yellow-400 mb-2 uppercase tracking-widest">{winner.name}</h3>
                    <p className="text-6xl font-black mb-10 text-cyan-400">{winner.score} <span className="text-xl">PTS</span></p>
                    <button onClick={() => window.location.reload()} className="w-full btn-primary p-4 rounded-xl font-bold text-xl hover:rotate-2">üè† PLAY AGAIN</button>
                </div>
            );
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>